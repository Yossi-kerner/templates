version: 2
deploy:
  steps:
    setupVariables:
      after:
        - name: Get Vault Token Using CLI
          run: |
            curl https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip --output vault.zip
            unzip vault.zip
            ./vault write auth/jwt/login role="${VAULT_ROLE}" jwt="${ENV0_OIDC_TOKEN}"
            echo ./vault write auth/jwt/login role="${VAULT_ROLE}" jwt="${ENV0_OIDC_TOKEN}" -format=json | jq --raw-output '.auth.client_token'
            export VAULT_TOKEN=$(./vault write auth/jwt/login role="${VAULT_ROLE}" jwt="${ENV0_OIDC_TOKEN}" -format=json | jq --raw-output '.auth.client_token')
            echo $VAULT_TOKEN
            echo "Running some Vault commands"
            ./vault kv put -mount=secrets-for-env0 creds passcode=my-long-passcode
            ./vault kv get -mount=secrets-for-env0 -field=passcode creds