version: 2
deploy:
  steps:
    terraformInit:
      after:
        - name: After Init
          run: terraform init -upgrade
    setupVariables:
      after:
        - name: Get Vault Token Using CLI
          run: |
            echo https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip --output vault.zip
            curl https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip --output vault.zip
            unzip vault.zip
            echo unzipped vault
            ./vault write auth/jwt/login role="${VAULT_ROLE_NAME}" jwt="${ENV0_OIDC_TOKEN}"
        - name: Configure Vault
          run: ./configure-vault.sh
        - name: Test Vault
          run: ./test-vault.sh
    terraformPlan:
      after:
        - name: After Plan
          run: terraform show -json .tf-plan | jq '.' > .checkov_input.json
